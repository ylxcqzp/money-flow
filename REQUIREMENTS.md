# Money Flow 需求规格说明书 (SRS)

## 1. 项目概述

**Money Flow** 是一款基于 Web 的个人财务管理应用，旨在帮助用户轻松记录收支、管理账户资产、规划预算以及通过数据可视化分析财务状况。项目采用现代化前端技术栈构建，强调交互体验与数据隐私（本地化存储）。

## 2. 技术架构

- **前端框架**: Vue 3 (Composition API + `<script setup>`)
- **构建工具**: Vite
- **状态管理**: Pinia (Setup Store模式)
- **UI 样式**: Tailwind CSS v4
- **图标库**: Lucide Vue Next
- **图表库**: Apache ECharts (via vue-echarts)
- **日期处理**: date-fns
- **数据存储**: RESTful API (后端持久化) + LocalStorage (Token 与汇率缓存)
- **缓存与消息**: Redis（验证码/限流/令牌） + SMTP 邮件服务

## 3. 功能模块详解

### 3.1 用户认证 (User Authentication)
用户身份验证与授权功能，确保数据安全。

- **用户注册**:
  - 支持邮箱注册新账户。
  - 必填信息：用户名、邮箱、密码。
  - 密码需满足安全要求。
- **用户登录**:
  - 支持邮箱密码登录。
  - 登录成功后获取 accessToken，用于后续 API 请求的身份验证。
  - accessToken 与 refreshToken 自动存储在 LocalStorage 中，刷新页面后保持登录状态。
- **退出登录**:
  - 清除本地存储的 accessToken、refreshToken 和用户信息，重置 Store 状态。
  - 退出后跳转至登录页面。
- **身份验证与错误处理**:
  - **请求拦截**: 所有 API 请求在 Header 中携带 `Authorization: Bearer <accessToken>`。
  - **统一异常拦截**: 
    - 接口返回 `code !== 0` 时，通过 Toast 弹出错误提示。
    - 处理特定业务码：`400` (参数错误)、`401` (未授权/Token失效)、`403` (无权限)、`409` (冲突)、`500` (系统错误)。
  - **自动跳转**: 非登录接口返回 `401` 时，自动注销并跳转至登录页。

- **邮箱注册与验证码流程**:
  - 前端点击“发送验证码”，后端提供接口 `POST /api/auth/send-code`，参数：邮箱。
  - 合法性检查：后端再次校验邮箱格式，防止绕过前端。
  - 查重：查询数据库是否已存在该邮箱，存在则返回冲突错误（409）。
  - 防刷机制：按 IP 与邮箱双维度限流（如单邮箱/单 IP 的最小间隔与单位时间次数限制）。
  - 生成验证码：随机 4-6 位数字或字母，推荐 6 位。
  - 存储验证码：将“邮箱-验证码”存入缓存（Redis/数据库），设置过期时间 5-10 分钟，并记录发送计数与时间戳。
  - 发送邮件：调用 SMTP 邮件服务发送验证码邮件，包含有效期说明与安全提示。

- **完成注册**:
  - 接口：`POST /api/auth/register`，参数包含邮箱、密码、验证码。
  - 核对：后端从缓存读取该邮箱的验证码并比对，验证一致与未过期方可继续。
  - 存库：对密码进行安全加密（如 BCrypt），写入用户表并初始化必要的用户信息。
  - 清理：注册成功后删除验证码缓存与相关速率记录，避免重复使用。

- **登录与令牌刷新机制**:
  - 登录：`POST /api/auth/login`，校验邮箱与密码，成功后签发 `accessToken` 与 `refreshToken`。
  - 令牌策略：`accessToken` 短期有效（用于授权），`refreshToken` 较长期有效（用于刷新），与用户/设备绑定。
  - 刷新：`POST /api/auth/refresh`，校验 `refreshToken`，签发新的 `accessToken`（可采用刷新令牌轮换策略）。
  - 失效：注销或风控触发时，服务端主动使 `refreshToken` 失效并清理缓存记录。

- **错误与反馈**:
  - 验证码相关错误（过期、错误、频率限制）统一以标准错误码返回，并在前端以 Toast 呈现。
  - 注册/登录失败的详细原因通过统一异常处理返回，便于用户理解与运维定位。

### 3.2 交易管理 (Transaction Management)
核心功能，用于记录每一笔资金流动。

- **记账功能**:
  - 支持记录三种类型的交易：**支出**、**收入**、**转账**。
  - **必填信息**: 金额、日期、账户（转账需选择转出/转入账户）、分类。
  - **选填信息**: 备注、标签（支持多标签）。
  - **多币种支持**: 记录交易时可选择原币种，系统基于实时汇率折算为本位币 (CNY)。
- **交易列表**:
  - **灵活筛选**: 支持按 **年**、**月**、**日** 维度筛选，或在自定义报表中进行 **时间跨度** 筛选。
  - **多维过滤**: 支持按账户、标签、分类进行复合过滤。
  - **智能排序**: 支持按 **日期**、**金额**、**分类名称** 进行排序。
- **编辑与删除**: 支持对已生成的交易记录进行编辑或删除，自动同步更新账户余额。

### 3.3 账户资产管理 (Account Management)
管理用户的资金存放位置。

- **账户类型**: 预设现金、银行卡、支付宝、微信支付等类型，支持自定义。
- **资产概览**: 实时计算各账户余额及总资产（初始余额 + 收入 - 支出 ± 转账）。
- **账户操作**:
  - **新增账户**: 自定义账户名称、类型、图标及初始余额。
  - **编辑/删除**: 修改账户信息；若账户下存在关联交易，禁止删除以保证数据一致性。

### 3.4 预算管理 (Budget Management)
帮助用户控制消费，避免超支。

- **月度预算**:
  - 支持按月设置总预算金额。
  - 支持对特定 **支出分类** 单独设置子预算。
- **预算监控**:
  - 实时展示预算使用进度条。
  - **超支预警**: 当支出超过预算一定比例（如80%、100%）时，提供视觉反馈或建议。
- **智能建议**: 基于当前预算执行情况，提供“复盘建议”（如：某分类超支警告、储蓄率偏低提醒）。

### 3.5 统计与分析 (Statistics & Analysis)
核心功能，用于可视化展示财务状况，并支持高级报表导出。

- **收支概览**: 展示所选时间段内的总收入、总支出、结余及储蓄率。
- **分类统计与下钻**:
  - **支出/收入排行**: 按分类统计金额及占比，支持排行榜视图。
  - **交互式图表**: 使用 ECharts 展示分类占比（饼图）与收支趋势（折线图）。
  - **分类下钻**: 支持在饼图中点击父分类，查看其关联子分类的详细分布。
- **高级筛选**: 支持时间跨度、账户范围、多标签组合筛选。
- **数据导出**:
  - **PDF 导出**: 使用 `html2canvas` + `jsPDF` 将报表内容高清导出为 PDF，包含概览指标与可视化图表。
  - **Excel 导出**: 使用 `xlsx` 库将筛选后的明细数据导出为表格，支持日期、类型、分类、备注、账户、金额及标签等字段。

### 3.6 周期性账单 (Recurring Transactions)
自动化处理固定频率的收支。

- **规则配置**: 设置金额、分类、账户、频率（每天/每周/每月/每年）及开始日期。
- **自动生成**: 系统初始化时自动检查，若达到预定时间，自动生成对应的交易记录。
- **管理**: 支持查看、暂停或删除周期性规则。

### 3.7 储蓄目标 (Savings Goals)
激励用户存钱的功能。

- **目标设定**: 创建目标（如“买房”、“旅行”），设置目标金额、截止日期、专属图标。
- **进度追踪**: 记录存入/取出资金，实时更新进度条，计算剩余金额与时间。

### 3.8 分类管理 (Category Management)
灵活的收支分类体系。

- **两级分类**: 支持父子两级分类结构，内置常用分类。
- **自定义**: 支持新增、编辑、删除分类及其图标。删除时校验引用完整性。

### 3.9 设置与数据 (Settings)
- **汇率管理**: 集成 `er-api.com` 汇率 API，支持手动/自动更新汇率，用于多币种实时折算。
- **数据同步**: 所有业务数据通过 RESTful API 与后端同步。JWT Token、汇率数据、用户偏好等缓存于 LocalStorage。

## 4. 业务规则与约束

1.  **金额逻辑**:
    - 支出记为负向流出，收入记为正向流入。
    - 转账不影响总资产，只改变不同账户间的余额分布。
2.  **删除约束**:
    - 包含关联数据的实体（如已被交易使用的账户或分类）不可直接删除，需先处理关联数据。
3.  **时间处理**:
    - 所有日期存储为 ISO 格式，前端展示时根据本地化设置（zh-CN）格式化。

## 5. 界面与交互要求

- **响应式设计**: 适配桌面端与移动端访问。
- **视觉反馈**: 操作成功/失败需有 Toast 通知提示。
- **空状态**: 列表为空时需展示友好的引导页或插图。
- **主题色**: 
    - 收入: 翡翠绿 (Emerald)
    - 支出: 玫瑰红 (Rose)
    - 余额/转账: 蓝色 (Blue/Primary)
    - 预算/警告: 橙色 (Orange)
